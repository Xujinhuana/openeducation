# 🚀 AstrOb 部署配置指南

## 📋 目录
- [GitHub Pages 部署](#github-pages-部署)
- [Vercel 部署](#vercel-部署)
- [环境变量对比](#环境变量对比)
- [常见问题](#常见问题)

---

## 🐙 GitHub Pages 部署

### 前置条件
- ✅ GitHub 账号
- ✅ 项目已推送到 GitHub 仓库
- ✅ 仓库为公开（或 GitHub Pro 账户）

### 1. 配置 GitHub Actions

**文件**: `.github/workflows/deploy.yml`

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Build site
        run: npm run build:github
        env:
          # ⚠️ 重要：设置这些环境变量
          SPACESHIP_BASE: /openeducation/  # 你的仓库名
          SPACESHIP_SITE: https://your-username.github.io
          SPACESHIP_AUTHOR: My Vault
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
```

### 2. GitHub 仓库设置

1. **进入仓库 Settings**
2. **Pages 设置**:
   - Source: `GitHub Actions`
   - Branch: 不需要选择（Actions 自动部署）
3. **保存配置**

### 3. 环境变量（可选，通过 Secrets）

如果不想在代码中硬编码：

**Settings → Secrets and variables → Actions → New repository secret**

```
SPACESHIP_BASE = /openeducation/
SPACESHIP_SITE = https://your-username.github.io
SPACESHIP_AUTHOR = My Vault
```

然后在 workflow 中使用：
```yaml
env:
  SPACESHIP_BASE: ${{ secrets.SPACESHIP_BASE }}
  SPACESHIP_SITE: ${{ secrets.SPACESHIP_SITE }}
  SPACESHIP_AUTHOR: ${{ secrets.SPACESHIP_AUTHOR }}
```

### 4. 注意事项

| 项目 | 配置 | 说明 |
|------|------|------|
| **base 路径** | `/仓库名/` | 必须与仓库名一致 |
| **site** | `https://username.github.io` | GitHub Pages 域名 |
| **Node 版本** | `20.x` | 推荐使用 LTS 版本 |
| **构建命令** | `npm run build:github` | 不要用 `build`（会删除 node_modules） |

---

## ▲ Vercel 部署

### 方法 1: 通过 Vercel Dashboard（推荐）

#### 1. 导入项目

1. 访问 [vercel.com](https://vercel.com)
2. 点击 **"Add New" → "Project"**
3. 导入 GitHub 仓库
4. 选择 `AstrOb` 项目

#### 2. 配置构建设置

**Framework Preset**: `Astro`

**Build & Development Settings**:
```
Build Command:         npm run build:github
Output Directory:      dist
Install Command:       npm install
Development Command:   npm run dev
```

#### 3. 环境变量设置

在 **"Environment Variables"** 添加：

| Name | Value | Environment |
|------|-------|-------------|
| `SPACESHIP_BASE` | `/openeducation/` 或 `/` | All |
| `SPACESHIP_SITE` | `https://your-project.vercel.app` | All |
| `SPACESHIP_AUTHOR` | `My Vault` | All |
| `PWD` | `/vercel/path0` | All |

⚠️ **Vercel base 路径建议**：
- 使用根路径 `/` 更简单
- 或者使用自定义子路径

#### 4. 部署

点击 **"Deploy"** 按钮，Vercel 会自动：
1. 安装依赖
2. 构建项目
3. 部署到 CDN

---

### 方法 2: 使用 vercel.json 配置

**文件**: `vercel.json`

```json
{
  "buildCommand": "npm run build:github",
  "outputDirectory": "dist",
  "framework": "astro",
  "installCommand": "npm install",
  "devCommand": "npm run dev",
  "env": {
    "SPACESHIP_BASE": "/",
    "SPACESHIP_SITE": "https://your-project.vercel.app",
    "SPACESHIP_AUTHOR": "My Vault"
  },
  "regions": ["hkg1", "sin1"]
}
```

---

### 方法 3: Vercel CLI 部署

#### 安装 Vercel CLI
```bash
npm install -g vercel
```

#### 登录
```bash
vercel login
```

#### 部署
```bash
# 首次部署（会询问配置）
vercel

# 或者直接生产部署
vercel --prod
```

---

## 🔄 环境变量对比

| 环境 | base | site | author | 访问地址 |
|------|------|------|--------|---------|
| **本地开发** | `/astro-theme-spaceship/` | `http://localhost:4321` | `My Vault` | `http://localhost:4321/astro-theme-spaceship/` |
| **GitHub Pages** | `/openeducation/` | `https://username.github.io` | `My Vault` | `https://username.github.io/openeducation/` |
| **Vercel** | `/` 或自定义 | `https://xxx.vercel.app` | `My Vault` | `https://xxx.vercel.app/` |

---

## ⚙️ 推荐配置策略

### 策略 1: 不同平台不同 base（当前方案）

**astro.config.ts**:
```typescript
const isLocalDev = process.env.LOCAL_DEV === 'true' || process.env.NODE_ENV === 'development';

export default defineConfig({
  site: isLocalDev 
    ? 'http://localhost:4321' 
    : (process.env.SPACESHIP_SITE || 'https://your-username.github.io'),
  base: isLocalDev 
    ? '/astro-theme-spaceship/' 
    : (process.env.SPACESHIP_BASE || '/openeducation/')
});
```

**优点**:
- ✅ 本地、GitHub、Vercel 可以使用不同路径
- ✅ 灵活配置

**缺点**:
- ⚠️ 需要在每个平台设置环境变量

---

### 策略 2: 统一使用根路径（推荐新项目）

**修改 astro.config.ts**:
```typescript
const isLocalDev = process.env.LOCAL_DEV === 'true' || process.env.NODE_ENV === 'development';

export default defineConfig({
  site: isLocalDev 
    ? 'http://localhost:4321' 
    : process.env.SPACESHIP_SITE,
  base: '/'  // 所有环境都用根路径
});
```

**优点**:
- ✅ 配置简单
- ✅ URL 简洁
- ✅ 适合 Vercel 和自定义域名

**缺点**:
- ⚠️ GitHub Pages 需要使用自定义域名
- ⚠️ 或者改变仓库设置为 `username.github.io` 仓库

---

## ⚠️ 常见问题

### 1. GitHub Pages 404 错误

**现象**: 访问 `https://username.github.io/openeducation/` 显示 404

**原因**: base 路径配置错误

**解决**:
```bash
# 检查环境变量
echo $SPACESHIP_BASE  # 应该是 /openeducation/

# 检查 dist/ 目录中的文件路径
# 所有链接应该包含 /openeducation/ 前缀
```

---

### 2. Vercel 构建失败

**现象**: `npm run build` 失败

**原因**: 使用了错误的构建命令

**解决**:
```json
{
  "buildCommand": "npm run build:github"  // ✅ 正确
  // 不要用 "npm run build" （会删除 node_modules）
}
```

---

### 3. CSS/JS 文件 404

**现象**: 页面加载但样式丢失

**原因**: base 路径不匹配

**解决**:
1. 检查 HTML 中的资源路径
2. 确保 `base` 配置正确
3. 清理缓存重新构建

---

### 4. 环境变量不生效

**现象**: 构建使用了错误的配置

**GitHub Actions**:
```yaml
- name: Build
  run: npm run build:github
  env:  # ⚠️ 确保在这里设置
    SPACESHIP_BASE: /openeducation/
```

**Vercel**:
- 检查 Dashboard → Settings → Environment Variables
- 确保选择了 "Production" 环境

---

### 5. Windows 路径问题（本地构建）

**现象**: 本地构建失败，路径包含反斜杠

**解决**: 已通过修改 `get-static-paths.ts` 解决
```typescript
import { join } from "node:path/posix";  // ✅ 强制 POSIX 路径
```

---

## 🔐 安全最佳实践

### 不要在代码中硬编码敏感信息

❌ **不好**:
```typescript
site: 'https://mysite.com',
base: '/my-secret-project/'
```

✅ **推荐**:
```typescript
site: process.env.SPACESHIP_SITE,
base: process.env.SPACESHIP_BASE || '/'
```

### 使用平台的 Secrets 功能

- **GitHub**: Settings → Secrets and variables
- **Vercel**: Settings → Environment Variables（可设置为 sensitive）

---

## 📋 部署前检查清单

### 本地构建测试
- [ ] 运行 `npm run build:github` 成功
- [ ] `dist/` 目录生成正确
- [ ] 本地预览 `npm run preview` 正常

### GitHub Pages
- [ ] `.github/workflows/deploy.yml` 配置正确
- [ ] 环境变量设置完成
- [ ] Pages 设置为 "GitHub Actions"
- [ ] base 路径与仓库名一致

### Vercel
- [ ] Framework 选择 "Astro"
- [ ] Build Command 设置正确
- [ ] 环境变量配置完成
- [ ] 域名配置（如需要）

---

## 🎯 快速部署命令

### GitHub Pages
```bash
# 推送代码自动触发部署
git add .
git commit -m "Update content"
git push origin main
```

### Vercel CLI
```bash
# 部署到生产环境
vercel --prod

# 部署到预览环境
vercel
```

---

## 📚 相关资源

- [Astro 部署文档](https://docs.astro.build/en/guides/deploy/)
- [GitHub Pages 文档](https://docs.github.com/en/pages)
- [Vercel 文档](https://vercel.com/docs)
- [Vercel 环境变量](https://vercel.com/docs/environment-variables)

---

**最后更新**: 2025-10-21  
**维护者**: AI Assistant

