# ğŸš€ AstrOb + Supabase é›†æˆæŒ‡å—

> æ··åˆæ¶æ„ï¼šé™æ€å†…å®¹ + åŠ¨æ€åŠŸèƒ½ = å®Œç¾åšå®¢

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AstrOb é™æ€ç½‘ç«™ï¼ˆAstroï¼‰        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Markdown  â”‚      â”‚  åŠ¨æ€åŠŸèƒ½  â”‚    â”‚
â”‚  â”‚  æ–‡ç« å†…å®¹  â”‚      â”‚  (Supabase) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â†“                     â†“           â”‚
â”‚  - æ–‡ç« åˆ—è¡¨            - è¯„è®ºç³»ç»Ÿ       â”‚
â”‚  - æ–‡ç« è¯¦æƒ…            - é˜…è¯»ç»Ÿè®¡       â”‚
â”‚  - æ ‡ç­¾åˆ†ç±»            - ç‚¹èµæ”¶è—       â”‚
â”‚                        - ç”¨æˆ·è®¤è¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                    â†“
    Obsidian ç¼–è¾‘         Supabase åç«¯
    Git ç‰ˆæœ¬æ§åˆ¶          å®æ—¶æ•°æ®åº“
```

### æ ¸å¿ƒç†å¿µ

**ä¿ç•™ä¼˜åŠ¿**ï¼š
- âœ… Markdown æ–‡ä»¶ç®¡ç†æ–‡ç« å†…å®¹
- âœ… Obsidian ç¼–è¾‘ä½“éªŒ
- âœ… Git ç‰ˆæœ¬æ§åˆ¶
- âœ… é™æ€ç½‘ç«™å¿«é€Ÿéƒ¨ç½²

**å¢åŠ åŠŸèƒ½**ï¼š
- âœ… è¯„è®ºç³»ç»Ÿ
- âœ… é˜…è¯»ç»Ÿè®¡
- âœ… ç‚¹èµåŠŸèƒ½
- âœ… ç”¨æˆ·æ”¶è—ï¼ˆå¯é€‰ï¼‰

---

## ğŸ¯ é›†æˆåŠŸèƒ½è§„åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ï¼ˆæ¨èï¼Œ2-3 å°æ—¶ï¼‰

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å®ç°éš¾åº¦ | ç”¨æˆ·ä»·å€¼ |
|------|--------|----------|----------|
| é˜…è¯»ç»Ÿè®¡ | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | äº†è§£æ–‡ç« çƒ­åº¦ |
| è¯„è®ºç³»ç»Ÿ | â­â­â­â­â­ | â­â­â­â˜†â˜† | è¯»è€…äº’åŠ¨ |
| ç‚¹èµåŠŸèƒ½ | â­â­â­â­â˜† | â­â­â˜†â˜†â˜† | å³æ—¶åé¦ˆ |

### ç¬¬äºŒé˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼Œ5-8 å°æ—¶ï¼‰

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å®ç°éš¾åº¦ | ç”¨æˆ·ä»·å€¼ |
|------|--------|----------|----------|
| ç”¨æˆ·è®¤è¯ | â­â­â­â˜†â˜† | â­â­â­â­â˜† | ä¸ªæ€§åŒ–ä½“éªŒ |
| æ”¶è—ç³»ç»Ÿ | â­â­â­â˜†â˜† | â­â­â­â˜†â˜† | ç”¨æˆ·ç•™å­˜ |
| æœç´¢åŠŸèƒ½ | â­â­â­â˜†â˜† | â­â­â­â­â˜† | å†…å®¹å‘ç° |

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šSupabase è´¦å·è®¾ç½®

### 1.1 æ³¨å†Œè´¦å·

1. è®¿é—® [Supabase](https://supabase.com)
2. ç‚¹å‡» "Start your project"
3. ä½¿ç”¨ GitHub è´¦å·ç™»å½•ï¼ˆæ¨èï¼‰

### 1.2 åˆ›å»ºé¡¹ç›®

```yaml
é¡¹ç›®é…ç½®ï¼š
  Organization: é€‰æ‹©æˆ–åˆ›å»ºç»„ç»‡
  Name: astrob-blog
  Database Password: ç”Ÿæˆå¼ºå¯†ç ï¼ˆä¿å­˜å¥½ï¼ï¼‰
  Region: Southeast Asia (Singapore) # ç¦»ä¸­å›½è¾ƒè¿‘
  Pricing Plan: Free # å…è´¹ç‰ˆè¶³å¤Ÿä½¿ç”¨
```

ç­‰å¾… 2-3 åˆ†é’Ÿé¡¹ç›®åˆå§‹åŒ–å®Œæˆã€‚

### 1.3 è·å– API å¯†é’¥

1. è¿›å…¥é¡¹ç›® Dashboard
2. ç‚¹å‡»å·¦ä¾§ **Settings** â†’ **API**
3. å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼š

```env
Project URL: https://xxxxx.supabase.co
anon/public key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
service_role key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (ä»…æœåŠ¡ç«¯ä½¿ç”¨)
```

**âš ï¸ æ³¨æ„**ï¼š
- `anon key`ï¼šå¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨ï¼ˆå®‰å…¨ï¼‰
- `service_role key`ï¼šåªèƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨ï¼ˆæ•æ„Ÿï¼‰

---

## ğŸ—„ï¸ ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

### 2.1 è¿›å…¥ SQL Editor

1. Supabase Dashboard â†’ å·¦ä¾§èœå• **SQL Editor**
2. ç‚¹å‡» **New query**

### 2.2 åˆ›å»ºè¡¨ç»“æ„

å¤åˆ¶ä»¥ä¸‹ SQL å¹¶æ‰§è¡Œï¼š

```sql
-- ============================================
-- 1. æ–‡ç« ç»Ÿè®¡è¡¨
-- ============================================
CREATE TABLE article_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,  -- æ–‡ç« è·¯å¾„ï¼ˆå¦‚ "my-first-post"ï¼‰
  views INTEGER DEFAULT 0,     -- æµè§ˆé‡
  likes INTEGER DEFAULT 0,     -- ç‚¹èµæ•°
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ä¸º slug åˆ›å»ºç´¢å¼•ï¼ˆåŠ é€ŸæŸ¥è¯¢ï¼‰
CREATE INDEX idx_article_stats_slug ON article_stats(slug);

-- ============================================
-- 2. è¯„è®ºè¡¨
-- ============================================
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  article_slug TEXT NOT NULL,           -- æ–‡ç« è·¯å¾„
  author_name TEXT NOT NULL,            -- è¯„è®ºè€…æ˜µç§°
  author_email TEXT,                    -- é‚®ç®±ï¼ˆå¯é€‰ï¼‰
  content TEXT NOT NULL,                -- è¯„è®ºå†…å®¹
  parent_id UUID,                       -- çˆ¶è¯„è®ºIDï¼ˆæ”¯æŒå›å¤ï¼‰
  status TEXT DEFAULT 'approved',       -- çŠ¶æ€ï¼šapproved/pending/spam
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- å¤–é”®çº¦æŸï¼šæ”¯æŒè¯„è®ºå›å¤
  FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
);

-- ä¸º article_slug åˆ›å»ºç´¢å¼•
CREATE INDEX idx_comments_article_slug ON comments(article_slug);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);

-- ============================================
-- 3. ç‚¹èµè®°å½•è¡¨ï¼ˆé˜²æ­¢é‡å¤ç‚¹èµï¼‰
-- ============================================
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  article_slug TEXT NOT NULL,
  user_identifier TEXT NOT NULL,  -- IP åœ°å€æˆ–ç”¨æˆ·ID
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- å”¯ä¸€çº¦æŸï¼šåŒä¸€ç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡
  UNIQUE(article_slug, user_identifier)
);

-- ============================================
-- 4. é˜…è¯»è®°å½•è¡¨ï¼ˆè¯¦ç»†ç»Ÿè®¡ï¼‰
-- ============================================
CREATE TABLE page_views (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  article_slug TEXT NOT NULL,
  user_agent TEXT,
  referrer TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_page_views_article_slug ON page_views(article_slug);
CREATE INDEX idx_page_views_created_at ON page_views(created_at);

-- ============================================
-- 5. è§¦å‘å™¨ï¼šè‡ªåŠ¨æ›´æ–° updated_at
-- ============================================
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_article_stats_updated_at
BEFORE UPDATE ON article_stats
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

ç‚¹å‡» **Run** æ‰§è¡Œ SQLã€‚

### 2.3 é…ç½®è¡Œçº§å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰

```sql
-- ============================================
-- å¼€å¯è¡Œçº§å®‰å…¨ï¼ˆRow Level Securityï¼‰
-- ============================================

-- å¯ç”¨ RLS
ALTER TABLE article_stats ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE likes ENABLE ROW LEVEL SECURITY;
ALTER TABLE page_views ENABLE ROW LEVEL SECURITY;

-- ============================================
-- æ–‡ç« ç»Ÿè®¡ï¼šæ‰€æœ‰äººå¯è¯»ï¼Œåªæœ‰æœåŠ¡ç«¯å¯å†™
-- ============================================
CREATE POLICY "Anyone can view article stats"
  ON article_stats FOR SELECT
  USING (true);

CREATE POLICY "Service role can insert article stats"
  ON article_stats FOR INSERT
  WITH CHECK (true);

CREATE POLICY "Service role can update article stats"
  ON article_stats FOR UPDATE
  USING (true);

-- ============================================
-- è¯„è®ºï¼šæ‰€æœ‰äººå¯è¯»å·²æ‰¹å‡†çš„ï¼Œä»»ä½•äººå¯åˆ›å»º
-- ============================================
CREATE POLICY "Anyone can view approved comments"
  ON comments FOR SELECT
  USING (status = 'approved');

CREATE POLICY "Anyone can create comments"
  ON comments FOR INSERT
  WITH CHECK (true);

-- ============================================
-- ç‚¹èµï¼šæ‰€æœ‰äººå¯è¯»ï¼Œå¯åˆ›å»º
-- ============================================
CREATE POLICY "Anyone can view likes"
  ON likes FOR SELECT
  USING (true);

CREATE POLICY "Anyone can create likes"
  ON likes FOR INSERT
  WITH CHECK (true);

-- ============================================
-- æµè§ˆè®°å½•ï¼šæ‰€æœ‰äººå¯åˆ›å»º
-- ============================================
CREATE POLICY "Anyone can create page views"
  ON page_views FOR INSERT
  WITH CHECK (true);
```

---

## ğŸ’» ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ–

### 3.1 å®‰è£… Supabase å®¢æˆ·ç«¯

```bash
cd F:/IOTO-Doc/AstrOb
npm install @supabase/supabase-js
```

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»ºæˆ–ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# Supabase é…ç½®
PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# æœåŠ¡ç«¯å¯†é’¥ï¼ˆä¸è¦æš´éœ²åˆ°å‰ç«¯ï¼ï¼‰
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 3.3 é…ç½® TypeScript ç±»å‹

åˆ›å»º `src/env.d.ts`ï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™ç¼–è¾‘ï¼‰ï¼š

```typescript
/// <reference types="astro/client" />

interface ImportMetaEnv {
  readonly PUBLIC_SUPABASE_URL: string
  readonly PUBLIC_SUPABASE_ANON_KEY: string
  readonly SUPABASE_SERVICE_ROLE_KEY: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

---

## ğŸ”§ ç¬¬å››æ­¥ï¼šåˆ›å»º Supabase å®¢æˆ·ç«¯

### 4.1 åˆ›å»ºå®¢æˆ·ç«¯å·¥å…·æ–‡ä»¶

åˆ›å»º `src/lib/supabase.ts`ï¼š

```typescript
import { createClient } from '@supabase/supabase-js';

// å‰ç«¯å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ anon keyï¼Œå®‰å…¨ï¼‰
export const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// æœåŠ¡ç«¯å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ service role keyï¼Œæƒé™æ›´é«˜ï¼‰
export const supabaseAdmin = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY
);
```

### 4.2 åˆ›å»ºç±»å‹å®šä¹‰

åˆ›å»º `src/lib/types.ts`ï¼š

```typescript
export interface ArticleStats {
  id: string;
  slug: string;
  views: number;
  likes: number;
  created_at: string;
  updated_at: string;
}

export interface Comment {
  id: string;
  article_slug: string;
  author_name: string;
  author_email?: string;
  content: string;
  parent_id?: string;
  status: 'approved' | 'pending' | 'spam';
  created_at: string;
  replies?: Comment[];  // å­è¯„è®º
}

export interface Like {
  id: string;
  article_slug: string;
  user_identifier: string;
  created_at: string;
}

export interface PageView {
  id: string;
  article_slug: string;
  user_agent?: string;
  referrer?: string;
  created_at: string;
}
```

---

## ğŸ“Š ç¬¬äº”æ­¥ï¼šå®ç°é˜…è¯»ç»Ÿè®¡

### 5.1 åˆ›å»º API ç«¯ç‚¹

åˆ›å»º `src/pages/api/stats/[slug].ts`ï¼š

```typescript
import type { APIRoute } from 'astro';
import { supabase, supabaseAdmin } from '@/lib/supabase';

// è·å–æ–‡ç« ç»Ÿè®¡
export const GET: APIRoute = async ({ params }) => {
  const { slug } = params;

  if (!slug) {
    return new Response(JSON.stringify({ error: 'Slug is required' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  try {
    // æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
    const { data, error } = await supabase
      .from('article_stats')
      .select('*')
      .eq('slug', slug)
      .single();

    if (error && error.code !== 'PGRST116') {
      throw error;
    }

    // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆå§‹è®°å½•
    if (!data) {
      const { data: newStats } = await supabaseAdmin
        .from('article_stats')
        .insert({ slug, views: 0, likes: 0 })
        .select()
        .single();

      return new Response(JSON.stringify(newStats || { views: 0, likes: 0 }), {
        headers: { 'Content-Type': 'application/json' }
      });
    }

    return new Response(JSON.stringify(data), {
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('Error fetching stats:', error);
    return new Response(JSON.stringify({ error: 'Failed to fetch stats' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
};

// å¢åŠ æµè§ˆé‡
export const POST: APIRoute = async ({ params, request }) => {
  const { slug } = params;

  if (!slug) {
    return new Response(JSON.stringify({ error: 'Slug is required' }), {
      status: 400
    });
  }

  try {
    // è®°å½•è¯¦ç»†æµè§ˆè®°å½•
    const userAgent = request.headers.get('user-agent') || '';
    const referrer = request.headers.get('referer') || '';

    await supabase.from('page_views').insert({
      article_slug: slug,
      user_agent: userAgent,
      referrer: referrer
    });

    // å¢åŠ æµè§ˆé‡è®¡æ•°
    const { data: stats } = await supabase
      .from('article_stats')
      .select('views')
      .eq('slug', slug)
      .single();

    if (stats) {
      // æ›´æ–°æµè§ˆé‡
      await supabaseAdmin
        .from('article_stats')
        .update({ views: stats.views + 1 })
        .eq('slug', slug);
    } else {
      // åˆ›å»ºåˆå§‹è®°å½•
      await supabaseAdmin
        .from('article_stats')
        .insert({ slug, views: 1, likes: 0 });
    }

    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('Error incrementing views:', error);
    return new Response(JSON.stringify({ error: 'Failed to increment views' }), {
      status: 500
    });
  }
};
```

### 5.2 åˆ›å»ºç»Ÿè®¡ç»„ä»¶

åˆ›å»º `src/components/ArticleStats.astro`ï¼š

```astro
---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div class="article-stats" data-slug={slug}>
  <div class="stat-item">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
      <circle cx="12" cy="12" r="3"></circle>
    </svg>
    <span class="stat-value" id="views-count">-</span>
    <span class="stat-label">æµè§ˆ</span>
  </div>

  <div class="stat-item">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
    </svg>
    <span class="stat-value" id="likes-count">-</span>
    <span class="stat-label">ç‚¹èµ</span>
  </div>
</div>

<style>
  .article-stats {
    display: flex;
    gap: 1.5rem;
    padding: 1rem 0;
    border-top: 1px solid var(--color-border, #e5e7eb);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    margin: 2rem 0;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-secondary, #6b7280);
  }

  .icon {
    width: 20px;
    height: 20px;
    stroke-width: 2;
  }

  .stat-value {
    font-weight: 600;
    color: var(--color-text, #1f2937);
  }

  .stat-label {
    font-size: 0.875rem;
  }
</style>

<script>
  const slug = document.querySelector('.article-stats')?.getAttribute('data-slug');

  if (slug) {
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch(`/api/stats/${slug}`);
        const data = await response.json();

        document.getElementById('views-count')!.textContent = data.views || '0';
        document.getElementById('likes-count')!.textContent = data.likes || '0';
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // å¢åŠ æµè§ˆé‡ï¼ˆé¡µé¢åŠ è½½æ—¶ï¼‰
    async function incrementViews() {
      try {
        await fetch(`/api/stats/${slug}`, { method: 'POST' });
      } catch (error) {
        console.error('Failed to increment views:', error);
      }
    }

    // æ‰§è¡Œ
    loadStats();
    incrementViews();
  }
</script>
```

### 5.3 åœ¨æ–‡ç« é¡µé¢ä¸­ä½¿ç”¨

ç¼–è¾‘æ–‡ç« æ¨¡æ¿ï¼ˆä¾‹å¦‚ `src/pages/[...slug].astro`ï¼‰ï¼š

```astro
---
import ArticleStats from '@/components/ArticleStats.astro';

const { slug } = Astro.params;
// ... å…¶ä»–ä»£ç 
---

<article>
  <h1>{title}</h1>
  
  <!-- æ–‡ç« ç»Ÿè®¡ -->
  <ArticleStats slug={slug} />
  
  <!-- æ–‡ç« å†…å®¹ -->
  <div set:html={content} />
</article>
```

---

## ğŸ’¬ ç¬¬å…­æ­¥ï¼šå®ç°è¯„è®ºç³»ç»Ÿ

### 6.1 åˆ›å»ºè¯„è®º API

åˆ›å»º `src/pages/api/comments/[slug].ts`ï¼š

```typescript
import type { APIRoute } from 'astro';
import { supabase } from '@/lib/supabase';

// è·å–è¯„è®ºåˆ—è¡¨
export const GET: APIRoute = async ({ params }) => {
  const { slug } = params;

  try {
    const { data, error } = await supabase
      .from('comments')
      .select('*')
      .eq('article_slug', slug)
      .eq('status', 'approved')
      .order('created_at', { ascending: true });

    if (error) throw error;

    // æ„å»ºè¯„è®ºæ ‘ï¼ˆæ”¯æŒå›å¤ï¼‰
    const commentsMap = new Map();
    const rootComments: any[] = [];

    data.forEach((comment: any) => {
      comment.replies = [];
      commentsMap.set(comment.id, comment);
    });

    data.forEach((comment: any) => {
      if (comment.parent_id) {
        const parent = commentsMap.get(comment.parent_id);
        if (parent) {
          parent.replies.push(comment);
        }
      } else {
        rootComments.push(comment);
      }
    });

    return new Response(JSON.stringify(rootComments), {
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('Error fetching comments:', error);
    return new Response(JSON.stringify({ error: 'Failed to fetch comments' }), {
      status: 500
    });
  }
};

// åˆ›å»ºæ–°è¯„è®º
export const POST: APIRoute = async ({ params, request }) => {
  const { slug } = params;
  const body = await request.json();

  const { author_name, author_email, content, parent_id } = body;

  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!author_name || !content) {
    return new Response(
      JSON.stringify({ error: 'Name and content are required' }),
      { status: 400 }
    );
  }

  // ç®€å•çš„åƒåœ¾è¯„è®ºæ£€æµ‹
  const spamKeywords = ['viagra', 'casino', 'porn'];
  const isSpam = spamKeywords.some(keyword =>
    content.toLowerCase().includes(keyword)
  );

  try {
    const { data, error } = await supabase
      .from('comments')
      .insert({
        article_slug: slug,
        author_name,
        author_email,
        content,
        parent_id,
        status: isSpam ? 'spam' : 'approved'
      })
      .select()
      .single();

    if (error) throw error;

    return new Response(JSON.stringify(data), {
      status: 201,
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('Error creating comment:', error);
    return new Response(
      JSON.stringify({ error: 'Failed to create comment' }),
      { status: 500 }
    );
  }
};
```

### 6.2 åˆ›å»ºè¯„è®ºç»„ä»¶

åˆ›å»º `src/components/Comments.astro`ï¼š

```astro
---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div class="comments-section" data-slug={slug}>
  <h2 class="comments-title">ğŸ’¬ è¯„è®ºåŒº</h2>

  <!-- è¯„è®ºè¡¨å• -->
  <form class="comment-form" id="comment-form">
    <div class="form-group">
      <input
        type="text"
        name="author_name"
        placeholder="æ˜µç§° *"
        required
        class="form-input"
      />
    </div>
    <div class="form-group">
      <input
        type="email"
        name="author_email"
        placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼‰"
        class="form-input"
      />
    </div>
    <div class="form-group">
      <textarea
        name="content"
        placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
        required
        rows="4"
        class="form-textarea"
      ></textarea>
    </div>
    <button type="submit" class="submit-btn">å‘è¡¨è¯„è®º</button>
  </form>

  <!-- è¯„è®ºåˆ—è¡¨ -->
  <div class="comments-list" id="comments-list">
    <p class="loading">åŠ è½½è¯„è®ºä¸­...</p>
  </div>
</div>

<style>
  .comments-section {
    margin: 3rem 0;
    padding: 2rem;
    background: var(--color-bg-secondary, #f9fafb);
    border-radius: 8px;
  }

  .comments-title {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
  }

  .comment-form {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #6366f1;
  }

  .form-textarea {
    resize: vertical;
    font-family: inherit;
  }

  .submit-btn {
    padding: 0.75rem 1.5rem;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .submit-btn:hover {
    background: #4f46e5;
  }

  .submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .comment {
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .comment-author {
    font-weight: 600;
    color: #1f2937;
  }

  .comment-date {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .comment-content {
    line-height: 1.6;
    color: #374151;
  }

  .comment-replies {
    margin-top: 1rem;
    margin-left: 2rem;
    padding-left: 1rem;
    border-left: 2px solid #e5e7eb;
  }

  .loading {
    text-align: center;
    color: #6b7280;
  }

  .empty {
    text-align: center;
    color: #9ca3af;
    padding: 2rem;
  }
</style>

<script>
  const slug = document.querySelector('.comments-section')?.getAttribute('data-slug');
  const form = document.getElementById('comment-form') as HTMLFormElement;
  const commentsList = document.getElementById('comments-list');

  // åŠ è½½è¯„è®º
  async function loadComments() {
    try {
      const response = await fetch(`/api/comments/${slug}`);
      const comments = await response.json();

      if (comments.length === 0) {
        commentsList!.innerHTML = '<p class="empty">è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥å‘è¡¨ç¬¬ä¸€æ¡å§ï¼</p>';
        return;
      }

      commentsList!.innerHTML = comments.map((comment: any) => renderComment(comment)).join('');
    } catch (error) {
      console.error('Failed to load comments:', error);
      commentsList!.innerHTML = '<p class="empty">åŠ è½½è¯„è®ºå¤±è´¥</p>';
    }
  }

  // æ¸²æŸ“è¯„è®º
  function renderComment(comment: any): string {
    const date = new Date(comment.created_at).toLocaleDateString('zh-CN');
    const replies = comment.replies?.map((reply: any) => renderComment(reply)).join('') || '';

    return `
      <div class="comment">
        <div class="comment-header">
          <span class="comment-author">${escapeHtml(comment.author_name)}</span>
          <span class="comment-date">${date}</span>
        </div>
        <div class="comment-content">${escapeHtml(comment.content)}</div>
        ${replies ? `<div class="comment-replies">${replies}</div>` : ''}
      </div>
    `;
  }

  // HTML è½¬ä¹‰
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // æäº¤è¯„è®º
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'æäº¤ä¸­...';

    const formData = new FormData(form);
    const data = {
      author_name: formData.get('author_name'),
      author_email: formData.get('author_email'),
      content: formData.get('content')
    };

    try {
      const response = await fetch(`/api/comments/${slug}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        form.reset();
        await loadComments();
        alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
      } else {
        alert('è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (error) {
      console.error('Failed to submit comment:', error);
      alert('è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'å‘è¡¨è¯„è®º';
    }
  });

  // åˆå§‹åŠ è½½
  loadComments();
</script>
```

### 6.3 åœ¨æ–‡ç« é¡µé¢ä¸­ä½¿ç”¨

```astro
---
import Comments from '@/components/Comments.astro';
---

<article>
  <!-- æ–‡ç« å†…å®¹ -->
  
  <!-- è¯„è®ºåŒº -->
  <Comments slug={slug} />
</article>
```

---

## ğŸ‘ ç¬¬ä¸ƒæ­¥ï¼šå®ç°ç‚¹èµåŠŸèƒ½

### 7.1 åˆ›å»ºç‚¹èµ API

åˆ›å»º `src/pages/api/likes/[slug].ts`ï¼š

```typescript
import type { APIRoute } from 'astro';
import { supabase, supabaseAdmin } from '@/lib/supabase';

// ç‚¹èµ
export const POST: APIRoute = async ({ params, request, clientAddress }) => {
  const { slug } = params;

  // ä½¿ç”¨ IP åœ°å€ä½œä¸ºç”¨æˆ·æ ‡è¯†ï¼ˆç®€å•æ–¹æ¡ˆï¼‰
  const userIdentifier = clientAddress || 'anonymous';

  try {
    // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
    const { data: existingLike } = await supabase
      .from('likes')
      .select('id')
      .eq('article_slug', slug)
      .eq('user_identifier', userIdentifier)
      .single();

    if (existingLike) {
      return new Response(
        JSON.stringify({ error: 'Already liked' }),
        { status: 400 }
      );
    }

    // æ·»åŠ ç‚¹èµè®°å½•
    await supabase.from('likes').insert({
      article_slug: slug,
      user_identifier: userIdentifier
    });

    // æ›´æ–°ç‚¹èµè®¡æ•°
    const { data: stats } = await supabase
      .from('article_stats')
      .select('likes')
      .eq('slug', slug)
      .single();

    if (stats) {
      await supabaseAdmin
        .from('article_stats')
        .update({ likes: stats.likes + 1 })
        .eq('slug', slug);

      return new Response(
        JSON.stringify({ likes: stats.likes + 1 }),
        { headers: { 'Content-Type': 'application/json' } }
      );
    }

    return new Response(JSON.stringify({ success: true }));
  } catch (error) {
    console.error('Error liking article:', error);
    return new Response(
      JSON.stringify({ error: 'Failed to like article' }),
      { status: 500 }
    );
  }
};

// æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
export const GET: APIRoute = async ({ params, clientAddress }) => {
  const { slug } = params;
  const userIdentifier = clientAddress || 'anonymous';

  try {
    const { data } = await supabase
      .from('likes')
      .select('id')
      .eq('article_slug', slug)
      .eq('user_identifier', userIdentifier)
      .single();

    return new Response(
      JSON.stringify({ liked: !!data }),
      { headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    return new Response(
      JSON.stringify({ liked: false }),
      { headers: { 'Content-Type': 'application/json' } }
    );
  }
};
```

### 7.2 åˆ›å»ºç‚¹èµæŒ‰é’®ç»„ä»¶

åˆ›å»º `src/components/LikeButton.astro`ï¼š

```astro
---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<button class="like-button" data-slug={slug} id="like-btn">
  <svg class="heart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
  </svg>
  <span class="like-count">-</span>
</button>

<style>
  .like-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
  }

  .like-button:hover {
    border-color: #ef4444;
    color: #ef4444;
  }

  .like-button.liked {
    background: #ef4444;
    border-color: #ef4444;
    color: white;
  }

  .like-button.liked .heart-icon {
    fill: currentColor;
  }

  .heart-icon {
    width: 20px;
    height: 20px;
    stroke-width: 2;
    transition: fill 0.2s;
  }

  .like-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ç‚¹èµåŠ¨ç”» */
  @keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  .like-button.animating {
    animation: heartbeat 0.3s ease;
  }
</style>

<script>
  const slug = document.getElementById('like-btn')?.getAttribute('data-slug');
  const button = document.getElementById('like-btn') as HTMLButtonElement;
  const countSpan = button?.querySelector('.like-count');

  if (slug && button) {
    // åŠ è½½ç‚¹èµçŠ¶æ€
    async function loadLikeStatus() {
      try {
        // è·å–ç‚¹èµæ•°
        const statsResponse = await fetch(`/api/stats/${slug}`);
        const stats = await statsResponse.json();
        countSpan!.textContent = stats.likes || '0';

        // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
        const likeResponse = await fetch(`/api/likes/${slug}`);
        const { liked } = await likeResponse.json();
        if (liked) {
          button.classList.add('liked');
        }
      } catch (error) {
        console.error('Failed to load like status:', error);
      }
    }

    // ç‚¹èµ
    button.addEventListener('click', async () => {
      if (button.classList.contains('liked')) {
        alert('æ‚¨å·²ç»ç‚¹èµè¿‡äº†ï¼');
        return;
      }

      button.disabled = true;

      try {
        const response = await fetch(`/api/likes/${slug}`, {
          method: 'POST'
        });

        if (response.ok) {
          const data = await response.json();
          button.classList.add('liked', 'animating');
          countSpan!.textContent = data.likes;

          setTimeout(() => {
            button.classList.remove('animating');
          }, 300);
        } else {
          const error = await response.json();
          alert(error.error || 'ç‚¹èµå¤±è´¥');
        }
      } catch (error) {
        console.error('Failed to like:', error);
        alert('ç‚¹èµå¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        button.disabled = false;
      }
    });

    // åˆå§‹åŠ è½½
    loadLikeStatus();
  }
</script>
```

---

## âœ… ç¬¬å…«æ­¥ï¼šæµ‹è¯•éªŒè¯

### 8.1 æµ‹è¯•æ¸…å•

- [ ] **ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®**
  ```bash
  # æ£€æŸ¥ .env æ–‡ä»¶
  cat .env
  ```

- [ ] **æ•°æ®åº“è¡¨å·²åˆ›å»º**
  ```
  åœ¨ Supabase Dashboard â†’ Table Editor æŸ¥çœ‹
  åº”è¯¥çœ‹åˆ°ï¼šarticle_stats, comments, likes, page_views
  ```

- [ ] **ä¾èµ–å·²å®‰è£…**
  ```bash
  npm list @supabase/supabase-js
  ```

- [ ] **Astro é…ç½® SSR æ¨¡å¼**
  ```typescript
  // astro.config.ts
  export default defineConfig({
    output: 'server',  // æˆ– 'hybrid'
    // ...
  });
  ```

### 8.2 åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•é˜…è¯»ç»Ÿè®¡**ï¼š
1. è®¿é—®æ–‡ç« é¡µé¢
2. æŸ¥çœ‹ç»Ÿè®¡æ•°å­—æ˜¯å¦æ˜¾ç¤º
3. åˆ·æ–°é¡µé¢ï¼Œæµè§ˆé‡åº”è¯¥å¢åŠ 

**æµ‹è¯•è¯„è®ºç³»ç»Ÿ**ï¼š
1. å¡«å†™è¯„è®ºè¡¨å•
2. æäº¤è¯„è®º
3. è¯„è®ºåº”è¯¥ç«‹å³æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­

**æµ‹è¯•ç‚¹èµåŠŸèƒ½**ï¼š
1. ç‚¹å‡»ç‚¹èµæŒ‰é’®
2. æŒ‰é’®å˜ä¸ºçº¢è‰²ï¼Œæ•°å­—å¢åŠ 
3. å†æ¬¡ç‚¹å‡»æç¤º"å·²ç‚¹èµ"

---

## ğŸ¯ ç¬¬ä¹æ­¥ï¼šéƒ¨ç½²é…ç½®

### 9.1 æ›´æ–° Astro é…ç½®

ç¼–è¾‘ `astro.config.ts`ï¼š

```typescript
import { defineConfig } from 'astro';
import { astroSpaceship } from 'astro-spaceship';
import websiteConfig from 'astro-spaceship/config';

export default defineConfig({
  output: 'server',  // å¯ç”¨ SSRï¼ˆå¿…é¡»ï¼‰
  integrations: [
    astroSpaceship(websiteConfig)
  ],
  devToolbar: {
    enabled: false
  },
  site: process.env.SPACESHIP_SITE || 'http://localhost:4321',
  base: process.env.SPACESHIP_BASE || '/openeducation/'
});
```

### 9.2 Vercel éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **å®‰è£… Vercel é€‚é…å™¨**ï¼š
   ```bash
   npx astro add vercel
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼š
   åœ¨ Vercel Dashboard â†’ Settings â†’ Environment Variables æ·»åŠ ï¼š
   ```
   PUBLIC_SUPABASE_URL
   PUBLIC_SUPABASE_ANON_KEY
   SUPABASE_SERVICE_ROLE_KEY
   ```

3. **éƒ¨ç½²**ï¼š
   ```bash
   git push origin main
   ```

### 9.3 Netlify éƒ¨ç½²

1. **å®‰è£… Netlify é€‚é…å™¨**ï¼š
   ```bash
   npx astro add netlify
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼š
   åœ¨ Netlify Dashboard â†’ Site settings â†’ Environment variables æ·»åŠ ç›¸åŒå˜é‡

---

## ğŸ“Š ç¬¬åæ­¥ï¼šç›‘æ§å’Œä¼˜åŒ–

### 10.1 æŸ¥çœ‹ç»Ÿè®¡æ•°æ®

åœ¨ Supabase Dashboard â†’ Table Editorï¼š

```sql
-- æŸ¥çœ‹æœ€çƒ­é—¨æ–‡ç« 
SELECT slug, views, likes
FROM article_stats
ORDER BY views DESC
LIMIT 10;

-- æŸ¥çœ‹è¯„è®ºæœ€å¤šçš„æ–‡ç« 
SELECT article_slug, COUNT(*) as comment_count
FROM comments
GROUP BY article_slug
ORDER BY comment_count DESC;

-- æŸ¥çœ‹æœ€è¿‘æµè§ˆè®°å½•
SELECT * FROM page_views
ORDER BY created_at DESC
LIMIT 20;
```

### 10.2 æ€§èƒ½ä¼˜åŒ–

**å‰ç«¯ä¼˜åŒ–**ï¼š
```typescript
// ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹è¯·æ±‚
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// ç¼“å­˜ç»Ÿè®¡æ•°æ®
const cache = new Map();
const CACHE_TIME = 60000; // 1åˆ†é’Ÿ
```

**æ•°æ®åº“ä¼˜åŒ–**ï¼š
```sql
-- å®šæœŸæ¸…ç†æ—§çš„æµè§ˆè®°å½•ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªæœˆï¼‰
DELETE FROM page_views
WHERE created_at < NOW() - INTERVAL '3 months';
```

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨çš„ AstrOb åšå®¢å·²ç»ï¼š
- âœ… ä¿ç•™äº† Markdown + Obsidian çš„ç¼–è¾‘ä½“éªŒ
- âœ… æ‹¥æœ‰äº†é˜…è¯»ç»Ÿè®¡åŠŸèƒ½
- âœ… æ‹¥æœ‰äº†å®Œæ•´çš„è¯„è®ºç³»ç»Ÿ
- âœ… æ‹¥æœ‰äº†ç‚¹èµäº’åŠ¨åŠŸèƒ½
- âœ… å®Œå…¨å…è´¹ï¼ˆSupabase å…è´¹ç‰ˆè¶³å¤Ÿä½¿ç”¨ï¼‰

---

## ğŸ“š æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### 1. ç”¨æˆ·è®¤è¯
- GitHub OAuth ç™»å½•
- åŒ¿åè¯„è®º vs æ³¨å†Œç”¨æˆ·

### 2. æœç´¢åŠŸèƒ½
- Supabase å…¨æ–‡æœç´¢
- æœç´¢å†å²è®°å½•

### 3. æ”¶è—åŠŸèƒ½
- ç”¨æˆ·æ”¶è—æ–‡ç« 
- ä¸ªäººæ”¶è—åˆ—è¡¨

### 4. é€šçŸ¥ç³»ç»Ÿ
- è¯„è®ºå›å¤é€šçŸ¥
- é‚®ä»¶é€šçŸ¥

è¯¦ç»†å®ç°è¯·å‚è€ƒ [Astro + Supabase å®˜æ–¹æ–‡æ¡£](https://docs.astro.build/en/guides/backend/supabase/)ã€‚

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹å¸¸è§é—®é¢˜æˆ–åœ¨ GitHub Issues ä¸­æé—®ã€‚

**ç¥ä½¿ç”¨æ„‰å¿«ï¼** ğŸš€

