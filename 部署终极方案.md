# 🚀 部署终极方案

## ⚠️ 核心问题

你的项目使用了 `astro-spaceship` 主题，该主题：
1. **强制使用 server 模式**（即使设置了 `static`）
2. **所有页面都依赖主题组件**
3. **页面包含 `export const prerender = true;`**（需要 adapter）

这导致：
- ❌ GitHub Pages **无法部署**（不支持 SSR/adapter）
- ❌ 移除主题后**没有页面内容**
- ❌ 移除 `prerender` 会破坏 Vercel 构建

---

## 💡 推荐方案：只使用 Vercel

### 为什么？

| 功能 | Vercel | GitHub Pages |
|------|--------|--------------|
| **SSR 支持** | ✅ 完整支持 | ❌ 不支持 |
| **Supabase** | ✅ 完整功能 | ❌ 不工作 |
| **astro-spaceship** | ✅ 完美兼容 | ❌ 不兼容 |
| **自动部署** | ✅ | ✅ |
| **自定义域名** | ✅ 免费 | ✅ 免费 |
| **HTTPS** | ✅ 自动 | ✅ 自动 |
| **构建速度** | ⚡ 快 | 🟡 中等 |
| **免费额度** | ✅ 充足 | ✅ 无限 |

**结论**：对于使用 `astro-spaceship` + Supabase 的项目，**Vercel 是唯一合适的选择**。

---

## ✅ 方案 A：仅 Vercel 部署（推荐）⭐⭐⭐⭐⭐

### 配置步骤

#### 1. 禁用 GitHub Pages

删除或禁用 `.github/workflows/deploy.yml`：

```bash
# 方式 1：删除文件
rm .github/workflows/deploy.yml

# 方式 2：重命名为 .bak（保留备份）
mv .github/workflows/deploy.yml .github/workflows/deploy.yml.bak
```

#### 2. 清理配置文件

删除不需要的静态配置：
```bash
rm astro.config.static.ts
```

#### 3. 简化 vercel.json

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".vercel/output",
  "framework": "astro"
}
```

#### 4. 更新 package.json

```json
{
  "scripts": {
    "dev": "astro dev",
    "build": "astro build",
    "preview": "astro preview"
  }
}
```

#### 5. 配置 Vercel 环境变量

在 Vercel Dashboard → Settings → Environment Variables：
```
PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

#### 6. 推送代码

```bash
git add .
git commit -m "chore: 简化部署配置，仅使用 Vercel"
git push origin main
```

### 优势

- ✅ **配置简单**：只需一个配置文件
- ✅ **完整功能**：Supabase 所有功能可用
- ✅ **维护轻松**：无需管理两套配置
- ✅ **构建稳定**：不会有 adapter 冲突
- ✅ **自动部署**：推送即部署
- ✅ **免费充足**：个人项目完全够用

### 访问方式

**Vercel 域名**：
```
https://your-project.vercel.app
```

**自定义域名**（可选）：
```
在 Vercel Dashboard → Settings → Domains 添加
```

---

## 🔄 方案 B：Vercel + Cloudflare Pages（备用）

如果你确实需要备份部署：

### 特点

- **主部署**：Vercel（完整功能）
- **备份**：Cloudflare Pages（支持 SSR）
- Cloudflare Pages 支持 Astro SSR（通过 adapter）

### 配置

```bash
# 安装 Cloudflare adapter
npm install @astrojs/cloudflare

# 创建 cloudflare 配置
# astro.config.cloudflare.ts
```

但老实说，**一个 Vercel 就够了**。

---

## ❌ 为什么不推荐 GitHub Pages？

### 技术限制

1. **不支持 SSR**
   - 只能托管静态 HTML/CSS/JS
   - 无法运行服务器端代码

2. **不支持 API 路由**
   - `/api/*` 路由全部 404
   - Supabase 功能完全不工作

3. **不支持 adapter**
   - 无法使用 `@astrojs/vercel` 等 adapter
   - `astro-spaceship` 依赖的功能不可用

### 项目限制

你的项目：
- ✅ 使用了 `astro-spaceship` 主题（需要 server 模式）
- ✅ 集成了 Supabase（需要 API 路由）
- ✅ 所有页面都有 `export const prerender = true;`

**这些都与 GitHub Pages 不兼容。**

---

## 🎯 实施建议

### 立即执行：切换到纯 Vercel 部署

```bash
# 1. 禁用 GitHub Pages workflow
mv .github/workflows/deploy.yml .github/workflows/deploy.yml.disabled

# 2. 删除静态配置
rm astro.config.static.ts

# 3. 恢复 Vercel 构建命令（移除 rm -rf）
# 编辑 vercel.json：
{
  "buildCommand": "npm run build"
}

# 4. 简化 package.json scripts
{
  "scripts": {
    "dev": "astro dev",
    "build": "astro build",
    "preview": "astro preview"
  }
}

# 5. 提交并推送
git add .
git commit -m "chore: 切换到纯 Vercel 部署"
git push origin main
```

---

## 📊 成本对比

### Vercel 免费套餐

```
✅ 100 GB 带宽/月
✅ 无限制的构建时间
✅ 自动 HTTPS
✅ 全球 CDN
✅ 无域名限制
✅ 团队协作（最多 3 人）

足够个人博客使用！
```

### GitHub Pages 免费套餐

```
✅ 100 GB 带宽/月
✅ 自动 HTTPS
✅ 无限制存储

但不支持 SSR 和你的项目需求
```

---

## 🔧 清理脚本

如果你同意切换到纯 Vercel，运行以下脚本：

```bash
#!/bin/bash
# cleanup-for-vercel.sh

echo "🧹 清理不必要的配置..."

# 禁用 GitHub Pages workflow
if [ -f ".github/workflows/deploy.yml" ]; then
  mv .github/workflows/deploy.yml .github/workflows/deploy.yml.disabled
  echo "✅ 已禁用 GitHub Pages workflow"
fi

# 删除静态配置
if [ -f "astro.config.static.ts" ]; then
  rm astro.config.static.ts
  echo "✅ 已删除静态配置文件"
fi

# 更新 .gitignore
if ! grep -q "^deploy.yml.disabled" .gitignore; then
  echo "deploy.yml.disabled" >> .gitignore
  echo "✅ 已更新 .gitignore"
fi

echo ""
echo "✅ 清理完成！"
echo ""
echo "📝 下一步："
echo "1. 编辑 vercel.json，修改 buildCommand 为 'npm run build'"
echo "2. 简化 package.json scripts（移除 build:github 和 build:vercel）"
echo "3. git add . && git commit -m 'chore: 简化部署配置'"
echo "4. git push origin main"
```

---

## ✅ 最终配置文件

### `astro.config.ts`（唯一配置）

```typescript
import { defineConfig } from 'astro/config';
import { astroSpaceship } from 'astro-spaceship';
import vercel from '@astrojs/vercel/serverless';
import websiteConfig from 'astro-spaceship/config';

export default defineConfig({
  output: 'server',
  adapter: vercel(),
  integrations: [astroSpaceship(websiteConfig)],
  devToolbar: { enabled: false },
  site: process.env.SPACESHIP_SITE || 'http://localhost:4321',
  base: process.env.SPACESHIP_BASE || '/openeducation/'
});
```

### `vercel.json`（简化）

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".vercel/output",
  "framework": "astro"
}
```

### `package.json`（简化 scripts）

```json
{
  "scripts": {
    "dev": "astro dev",
    "build": "astro build",
    "preview": "astro preview"
  }
}
```

---

## 💬 FAQ

### Q: 我一定要放弃 GitHub Pages 吗？

A: 对于你的项目，**是的**。原因：
- 你使用了 `astro-spaceship` 主题（需要 SSR）
- 你集成了 Supabase（需要 API 路由）
- GitHub Pages 不支持这些功能

### Q: Vercel 免费额度够用吗？

A: **绝对够用**。免费套餐：
- 100 GB 带宽/月
- 无限构建时间
- 无限部署次数

除非你的博客每月有 **上百万访问量**，否则不会超出。

### Q: 能用自定义域名吗？

A: **可以**。Vercel 免费支持自定义域名：
1. 在 Vercel Dashboard → Settings → Domains
2. 添加你的域名
3. 按提示配置 DNS

### Q: 数据会丢失吗？

A: **不会**。你的：
- ✅ 代码在 GitHub（不变）
- ✅ 内容在 Markdown（不变）
- ✅ Supabase 数据（不变）

只是改变了**部署方式**。

---

## 🎯 总结

### 当前问题

```
❌ GitHub Pages：不兼容 astro-spaceship + Supabase
❌ 双重配置：维护复杂，容易出错
❌ 功能缺失：GitHub Pages 版本功能不完整
```

### 推荐方案

```
✅ 只用 Vercel：配置简单，功能完整
✅ 单一配置：易于维护
✅ 完整功能：Supabase 正常工作
✅ 免费充足：个人博客完全够用
```

---

## 🚀 立即行动

我可以帮你：

1. **方案 A：切换到纯 Vercel**
   - 删除 GitHub Pages 配置
   - 简化项目结构
   - 一次配置，永久使用

2. **方案 B：保持现状（不推荐）**
   - 继续处理部署错误
   - 维护两套配置
   - GitHub Pages 版本功能不完整

**你选择哪个方案？**

告诉我：
- "切换到 Vercel" - 我帮你执行清理脚本
- "我想继续尝试" - 我会继续帮你调试（但可能很难解决）

