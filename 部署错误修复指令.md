# 🚨 部署错误快速修复指令

## 问题描述

- **GitHub Actions 报错**：`Invalid action input 'build'` 和 `EEXIST: file already exists`
- **Vercel 部署报错**：`EEXIST: file already exists, mkdir '.vercel/output/server/'`

## 🔧 立即执行的修复步骤

### 步骤 1：检查并清理 .vercel 目录

```bash
# 进入项目目录
cd F:/IOTO-Doc/AstrOb

# 检查 .vercel 目录是否被 Git 追踪
git ls-files | grep .vercel

# 如果有输出，说明被追踪了，需要删除
git rm -r --cached .vercel

# 提交更改
git commit -m "chore: remove .vercel directory from git tracking"
```

### 步骤 2：确认配置文件已更新

✅ **已完成的修改**（我已经帮你完成了）：

1. **`.gitignore`** - 已添加 `.vercel/` 忽略规则
2. **`.github/workflows/deploy.yml`** - 已修复 GitHub Actions 配置
3. **`构建配置说明.md`** - 已更新文档说明

### 步骤 3：推送修复到 GitHub

```bash
# 添加所有更改
git add .

# 提交更改
git commit -m "fix: resolve deployment errors for GitHub and Vercel"

# 推送到 GitHub
git push origin main
```

### 步骤 4：验证 Vercel 配置

确认 `vercel.json` 使用正确的构建命令：

```json
{
  "buildCommand": "npm run build:vercel",
  "outputDirectory": ".vercel/output",
  "framework": "astro"
}
```

如果 Vercel 还有问题，在 Vercel Dashboard 中：
1. 进入项目设置
2. **General** → **Build & Development Settings**
3. 点击 **Override** 开关
4. **Build Command**: `npm run build:vercel`
5. **Output Directory**: `.vercel/output`
6. 保存设置并重新部署

---

## 📋 验证清单

完成上述步骤后，检查以下项目：

- [ ] `.gitignore` 文件包含 `.vercel/` 行
- [ ] 运行 `git ls-files | grep .vercel` 无输出（确认未被追踪）
- [ ] `.github/workflows/deploy.yml` 使用新的 Node.js 构建步骤
- [ ] 本地测试 `npm run build:github` 成功生成 `dist/` 目录
- [ ] 本地测试 `npm run build:vercel` 成功生成 `.vercel/output/` 目录
- [ ] 推送代码到 GitHub 后，Actions 构建成功
- [ ] Vercel 自动部署成功

---

## 🎯 修复原理

### 为什么会出现 EEXIST 错误？

1. **根本原因**：`.vercel` 目录被提交到 Git 仓库
2. **冲突场景**：
   - GitHub Actions 运行时，检出代码包含了 `.vercel` 目录
   - 使用 `astro.config.ts`（server 模式）会尝试创建 `.vercel/output/server/`
   - 但该目录已存在，导致 `EEXIST` 错误

### 为什么会出现 Invalid action input 错误？

1. **根本原因**：`withastro/action@v2` 不支持 `build` 参数
2. **解决方案**：使用标准 Node.js 构建流程
   - 手动安装依赖（`npm ci`）
   - 手动运行构建命令（`npm run build:github`）
   - 手动上传构建产物（`actions/upload-pages-artifact@v3`）

---

## 🚀 部署目标配置总结

| 部署平台 | 构建命令 | 配置文件 | 模式 | 输出目录 | 功能 |
|---------|---------|---------|------|---------|------|
| **GitHub Pages** | `npm run build:github` | `astro.config.static.ts` | `static` | `dist/` | 仅静态 |
| **Vercel** | `npm run build:vercel` | `astro.config.ts` | `server` | `.vercel/output/` | 完整 SSR |

---

## 💡 最佳实践建议

1. **始终忽略构建产物**
   ```gitignore
   dist/
   .astro/
   .vercel/
   ```

2. **明确分离配置**
   - GitHub Pages → 静态配置（`astro.config.static.ts`）
   - Vercel → 服务器配置（`astro.config.ts`）

3. **本地测试优先**
   ```bash
   # 测试 GitHub Pages 构建
   npm run build:github
   
   # 测试 Vercel 构建
   npm run build:vercel
   ```

4. **优先使用 Vercel**
   - 支持完整的 SSR 和 API 路由
   - 支持 Supabase 等动态功能
   - 更好的性能和开发体验

---

## 📞 如果仍有问题

### GitHub Actions 持续失败

1. 检查 Actions 日志中的具体错误信息
2. 确认 `node-version: 22` 与 `package.json` 要求匹配
3. 确认 `dist/` 目录在构建后存在
4. 尝试在 GitHub Actions 中添加调试步骤：
   ```yaml
   - name: Debug - List files
     run: ls -la
   ```

### Vercel 部署持续失败

1. 在 Vercel Dashboard 查看详细构建日志
2. 确认环境变量已正确配置（如果使用 Supabase）
3. 尝试手动触发重新部署
4. 检查 `.vercel/output/` 是否被 `.gitignore` 忽略

---

## 📚 相关文档

- `构建配置说明.md` - 详细的构建配置说明
- `部署说明.md` - 部署平台配置指南
- `README.md` - 项目总览

---

**创建时间**：2025-10-23  
**状态**：✅ 配置文件已修复，等待推送验证

