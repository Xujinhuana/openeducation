# 🔧 构建配置说明

## 📊 配置文件对照表

| 文件 | 用途 | 模式 | Adapter | 部署目标 |
|------|------|------|---------|----------|
| `astro.config.ts` | 默认/Vercel | `server` | `@astrojs/vercel` | Vercel |
| `astro.config.static.ts` | GitHub Pages | `static` | 无 | GitHub Pages |

---

## 🎯 构建命令

### 本地开发
```bash
npm run dev
```
- 使用：`astro.config.ts`
- 模式：`server`
- 功能：完整的 Supabase 功能

### Vercel 构建
```bash
npm run build:vercel
```
- 使用：`astro.config.ts`
- 模式：`server`
- 输出：`.vercel/output/`
- 功能：完整的 Supabase 功能

### GitHub Pages 构建
```bash
npm run build:github
```
- 使用：`astro.config.static.ts`
- 模式：`static`
- 输出：`dist/`
- 功能：仅静态内容（无 Supabase 动态功能）

---

## 🚀 部署配置

### Vercel 部署

**1. `vercel.json` 配置**
```json
{
  "buildCommand": "npm run build:vercel",  // ← 关键
  "outputDirectory": ".vercel/output",
  "framework": "astro"
}
```

**2. 环境变量**

在 Vercel Dashboard → Settings → Environment Variables 添加：
```
PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

**3. 推送部署**
```bash
git push origin main
```

Vercel 会自动使用 `build:vercel` 命令构建。

---

### GitHub Pages 部署

**1. GitHub Actions 配置**

`.github/workflows/deploy.yml`:
```yaml
- name: Install, build, and upload your site
  uses: withastro/action@v2
  with:
    node-version: 22
    build: npm run build:github  # ← 关键：使用静态构建
```

**2. 推送部署**
```bash
git push origin main
```

GitHub Actions 会自动使用 `build:github` 命令构建静态网站。

---

## ⚠️ 常见错误

### 错误 1：Vercel "No adapter installed"

**错误信息**：
```
[NoAdapterInstalled] Cannot use server-rendered pages without an adapter.
```

**原因**：
- `vercel.json` 使用了 `build:github`（静态配置）
- 或 `@astrojs/vercel` 未安装

**解决**：
```json
// vercel.json - 修改为
{
  "buildCommand": "npm run build:vercel"
}
```

---

### 错误 2：GitHub Actions "EEXIST: file already exists"

**错误信息**：
```
EEXIST: file already exists, mkdir '.vercel/output/server/'
```

**原因**：
- GitHub Actions 使用了默认的 `astro.config.ts`
- 该配置包含 Vercel adapter，尝试创建 `.vercel/output` 目录

**解决**：
在 `.github/workflows/deploy.yml` 中指定静态构建：
```yaml
with:
  build: npm run build:github  # ← 添加这行
```

---

### 错误 3：构建命令不确定

**错误表现**：
- 不知道该用哪个构建命令
- 构建输出目录错误

**解决**：

| 部署目标 | 构建命令 | 配置文件 | 输出目录 |
|---------|---------|---------|----------|
| **本地开发** | `npm run dev` | `astro.config.ts` | - |
| **Vercel** | `npm run build:vercel` | `astro.config.ts` | `.vercel/output/` |
| **GitHub Pages** | `npm run build:github` | `astro.config.static.ts` | `dist/` |

---

## 🔍 验证配置

### 验证 Vercel 配置

**检查 `vercel.json`**：
```json
{
  "buildCommand": "npm run build:vercel",  // ✅ 正确
  "outputDirectory": ".vercel/output"      // ✅ 正确
}
```

**本地测试**：
```bash
npm run build:vercel
# 应该生成 .vercel/output/ 目录
ls .vercel/output/
```

---

### 验证 GitHub Pages 配置

**检查 `.github/workflows/deploy.yml`**：
```yaml
with:
  build: npm run build:github  # ✅ 必须指定
```

**本地测试**：
```bash
npm run build:github
# 应该生成 dist/ 目录
ls dist/
```

---

## 📋 完整检查清单

### Vercel 部署前

- [ ] `@astrojs/vercel` 已安装
- [ ] `astro.config.ts` 包含 `adapter: vercel()`
- [ ] `vercel.json` 的 `buildCommand` 是 `build:vercel`
- [ ] `vercel.json` 的 `outputDirectory` 是 `.vercel/output`
- [ ] Vercel Dashboard 已配置环境变量
- [ ] 本地测试 `npm run build:vercel` 成功

### GitHub Pages 部署前

- [ ] `astro.config.static.ts` 存在
- [ ] `astro.config.static.ts` 的 `output` 是 `static`
- [ ] `.github/workflows/deploy.yml` 指定了 `build: npm run build:github`
- [ ] 本地测试 `npm run build:github` 成功
- [ ] 理解功能限制（无动态功能）

---

## 🎯 推荐工作流

```
开发阶段
├─ npm run dev（本地开发）
├─ 使用 astro.config.ts
└─ 完整功能测试

准备部署
├─ 本地测试构建
│   ├─ npm run build:vercel（测试 Vercel 构建）
│   └─ npm run build:github（测试 GitHub 构建）
└─ 检查构建输出

推送代码
├─ git add .
├─ git commit -m "..."
└─ git push origin main

自动部署
├─ Vercel：自动检测并部署（使用 build:vercel）
└─ GitHub Pages：GitHub Actions 自动部署（使用 build:github）
```

---

## 💡 最佳实践

1. **不要混用配置**
   - Vercel 用 `astro.config.ts`
   - GitHub Pages 用 `astro.config.static.ts`

2. **明确指定构建命令**
   - Vercel：在 `vercel.json` 中指定
   - GitHub Pages：在 workflow 中指定

3. **本地测试**
   - 部署前先本地测试构建
   - 确保生成正确的输出目录

4. **环境隔离**
   - 开发环境用 server 模式（完整功能）
   - 生产环境根据部署目标选择配置

---

## 📚 相关文件

- `astro.config.ts` - Vercel 配置（server 模式）
- `astro.config.static.ts` - GitHub Pages 配置（static 模式）
- `vercel.json` - Vercel 构建配置
- `.github/workflows/deploy.yml` - GitHub Actions 配置
- `package.json` - 构建命令定义

---

**记住**：
- 🎯 Vercel = `build:vercel` = server 模式 = 完整功能
- 📄 GitHub Pages = `build:github` = static 模式 = 仅静态

**推荐**：优先使用 Vercel 部署，享受完整的 Supabase 功能！🚀

