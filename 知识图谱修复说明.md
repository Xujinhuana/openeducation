# 知识图谱修复说明

## 🎯 问题

Vercel 部署的网站上，知识图谱（Graph View）不显示，但 GitHub Pages 上正常。

## ✅ 已修复

使用 `patch-package` 修复了 `astro-spaceship` 组件的 URL 构建逻辑。

---

## 📦 修复内容

### 1. 修改的文件

- ✅ `node_modules/astro-spaceship/components/GraphView/GraphView.astro`
- ✅ `patches/astro-spaceship+0.9.8.patch`（补丁文件）
- ✅ `package.json`（添加 postinstall 脚本）

### 2. 修复逻辑

**原代码问题**（第 57 行）：
```javascript
const url = base ? `/${base.replace(/^\/+|\/+$/g, '')}/_spaceship/graph/${slug ?? "index"}.json` : `/_spaceship/graph/${slug ?? "index"}.json`;
```

当 `base="/"` 时，URL 构建有问题。

**修复后**：
```javascript
// 修复：处理根路径 "/" 的情况，确保URL正确构建
let basePath = base ? base.replace(/^\/+|\/+$/g, '') : '';
const url = basePath ? `/${basePath}/_spaceship/graph/${slug ?? "index"}.json` : `/_spaceship/graph/${slug ?? "index"}.json`;
```

---

## 🚀 部署到 GitHub & Vercel

### 步骤 1：提交更改

```bash
cd F:\IOTO-Doc\AstrOb

# 查看修改内容
git status

# 添加修改的文件
git add patches/astro-spaceship+0.9.8.patch
git add package.json

# 提交（使用中文提交信息）
git commit -m "修复知识图谱在Vercel上不显示的问题

- 使用patch-package修复GraphView组件URL构建逻辑
- 添加postinstall脚本自动应用补丁
- 修复当base为根路径时的URL解析问题"

# 推送到 GitHub
git push origin main
```

### 步骤 2：验证部署

**GitHub Pages**（自动部署）：
- 访问：https://xujinhuana.github.io/openeducation/obsidian-test
- 检查 Actions 标签页查看构建状态

**Vercel**（自动部署）：
- 访问：https://openeducation.vercel.app/obsidian-test
- 或访问 Vercel Dashboard 查看部署日志

### 步骤 3：测试知识图谱

1. 打开任意笔记页面
2. 点击右侧边栏的 **"Graph"** 标签
3. ✅ 应该显示知识图谱节点和连接线
4. 🔍 打开浏览器控制台（F12），确认没有错误

---

## 🧪 本地测试

如果想在本地测试修复：

```bash
cd F:\IOTO-Doc\AstrOb

# 重新安装依赖（会自动应用补丁）
npm install

# 构建项目
npm run build:github

# 预览
npm run preview
```

---

## 📋 技术细节

### patch-package 工作流程

1. **修改**：直接修改 `node_modules` 中的文件
2. **生成补丁**：`npx patch-package astro-spaceship`
3. **应用补丁**：`npm install` 时自动应用（通过 `postinstall` 脚本）

### 补丁文件位置

```
AstrOb/
├── patches/
│   └── astro-spaceship+0.9.8.patch  ← 补丁文件
├── package.json                     ← 包含 postinstall 脚本
└── node_modules/                    ← 修改会被应用到这里
```

### 为什么需要补丁？

- `astro-spaceship` 的 GraphView 组件在 `base="/"` 时 URL 构建有 bug
- 补丁文件会在每次 `npm install` 后自动应用
- Vercel 和 GitHub Actions 部署时都会自动应用

---

## ⚠️ 注意事项

### 1. 不要手动编辑补丁文件

如果需要修改，应该：
```bash
# 1. 修改 node_modules 中的源文件
# 2. 重新生成补丁
npx patch-package astro-spaceship --exclude "nothing"
```

### 2. 升级 astro-spaceship 时

如果升级了 `astro-spaceship` 到新版本：
```bash
# 检查补丁是否还能应用
npm install

# 如果失败，需要重新创建补丁
# 1. 删除旧补丁
rm patches/astro-spaceship+*.patch

# 2. 修改新版本的文件
# 3. 重新生成补丁
npx patch-package astro-spaceship --exclude "nothing"
```

### 3. CI/CD 自动部署

GitHub Actions 和 Vercel 都会：
- ✅ 自动运行 `npm install`
- ✅ 自动执行 `postinstall` 脚本
- ✅ 自动应用补丁

所以只需推送代码即可。

---

## 📚 相关文档

- [Vercel知识图谱显示问题分析](../4-Outcome/日常工作/总结/Vercel知识图谱显示问题分析.md) - 详细的问题分析
- [部署快速参考](./部署快速参考.md) - 部署命令和配置
- [部署配置指南](./部署配置指南.md) - 完整的部署指南

---

## 🔗 在线演示

- **GitHub Pages**：https://xujinhuana.github.io/openeducation/obsidian-test
- **Vercel**：https://openeducation.vercel.app/obsidian-test

两个平台的知识图谱现在应该都能正常显示！✨

---

**创建日期**：2024-10-22  
**作者**：AI Assistant  
**状态**：✅ 已完成并测试

