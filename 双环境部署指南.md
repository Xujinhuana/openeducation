# 🚀 双环境部署指南

## 📋 概述

本项目支持同时部署到两个平台：
- **GitHub Pages**：纯静态内容，无 Supabase 功能
- **Vercel**：完整功能，包含 Supabase 交互

通过环境变量 `PUBLIC_ENABLE_SUPABASE` 自动切换功能。

---

## 🎯 功能对比

| 功能 | GitHub Pages | Vercel |
|------|--------------|--------|
| **文章内容** | ✅ | ✅ |
| **页面导航** | ✅ | ✅ |
| **主题切换** | ✅ | ✅ |
| **浏览量统计** | ❌ | ✅ |
| **点赞功能** | ❌ | ✅ |
| **评论系统** | ❌ | ✅ |
| **API 路由** | ❌ | ✅ |
| **Supabase** | ❌ | ✅ |

---

## 🔧 配置说明

### 环境变量

#### `PUBLIC_ENABLE_SUPABASE`

**作用**：控制是否启用 Supabase 相关功能

**可选值**：
- `'true'` - 启用 Supabase 功能（Vercel 部署）
- `'false'` - 禁用 Supabase 功能（GitHub Pages 部署）

**影响范围**：
- 文章浏览量统计显示
- API 路由调用
- 统计组件注入
- 点赞按钮显示
- 评论功能显示

---

## 🚀 部署配置

### 方案 1：GitHub Pages 部署（纯静态）

#### 自动部署配置

已在 `.github/workflows/deploy.yml` 中配置：

```yaml
- name: Build with Astro (Static for GitHub Pages)
  run: npm run build:github
  env:
    SPACESHIP_SITE: https://xujinhuana.github.io
    SPACESHIP_BASE: /openeducation/
    SPACESHIP_AUTHOR: My Vault
    PUBLIC_ENABLE_SUPABASE: 'false'  # ← 禁用 Supabase
```

#### 构建配置

- **配置文件**：`astro.config.static.ts`
- **模式**：`static`
- **输出目录**：`dist/`
- **构建命令**：`npm run build:github`

#### 部署结果

访问 `https://xujinhuana.github.io/openeducation/`：
- ✅ 所有文章正常显示
- ✅ 导航、样式、主题正常
- ❌ 不显示浏览量统计
- ❌ 不显示点赞按钮
- ❌ 浏览器控制台无 API 错误

---

### 方案 2：Vercel 部署（完整功能）

#### Vercel 环境变量配置

在 Vercel Dashboard → Settings → Environment Variables 添加：

```
PUBLIC_ENABLE_SUPABASE=true
PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

#### 构建配置

- **配置文件**：`astro.config.ts`
- **模式**：`server`
- **Adapter**：`@astrojs/vercel`
- **输出目录**：`.vercel/output/`
- **构建命令**：`npm run build:vercel`

#### 部署结果

访问 `https://your-project.vercel.app/openeducation/`：
- ✅ 所有文章正常显示
- ✅ 导航、样式、主题正常
- ✅ 显示浏览量统计
- ✅ 显示点赞按钮
- ✅ 所有 Supabase 功能正常工作

---

## 🛠️ 本地开发

### 步骤 1：创建 .env 文件

```bash
# 复制示例文件
cp .env.example .env
```

### 步骤 2：配置环境变量

编辑 `.env` 文件：

```env
# 启用 Supabase 功能
PUBLIC_ENABLE_SUPABASE=true

# Supabase 配置
PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### 步骤 3：启动开发服务器

```bash
npm run dev
```

### 测试不同环境

**测试 Vercel 模式（完整功能）**：
```bash
# .env 中设置
PUBLIC_ENABLE_SUPABASE=true

# 启动
npm run dev
```

**测试 GitHub Pages 模式（纯静态）**：
```bash
# .env 中设置
PUBLIC_ENABLE_SUPABASE=false

# 构建
npm run build:github

# 预览
npm run preview
```

---

## 📂 文件说明

### 修改的文件

#### 1. `src/components/ArticleStats.astro`
```astro
---
// 检查是否启用 Supabase
const enableSupabase = import.meta.env.PUBLIC_ENABLE_SUPABASE === 'true';
---

{enableSupabase ? (
  <!-- 显示统计 -->
) : (
  <!-- 不显示统计 -->
)}
```

#### 2. `src/scripts/inject-article-stats.ts`
```typescript
// 检查环境变量
const enableSupabase = import.meta.env.PUBLIC_ENABLE_SUPABASE === 'true';

if (!enableSupabase) {
  // 不执行任何操作
} else {
  // 注入统计组件
}
```

#### 3. `src/pages/[...slug].astro`
```astro
<!-- 条件注入统计脚本 -->
{import.meta.env.PUBLIC_ENABLE_SUPABASE === 'true' && (
  <script>
    import '@/scripts/inject-article-stats.ts';
  </script>
)}
```

#### 4. `.github/workflows/deploy.yml`
```yaml
env:
  PUBLIC_ENABLE_SUPABASE: 'false'  # GitHub Pages 禁用
```

---

## ✅ 验证清单

### GitHub Pages 部署验证

- [ ] 推送代码到 GitHub
- [ ] GitHub Actions 构建成功
- [ ] 访问 `https://xujinhuana.github.io/openeducation/`
- [ ] 文章内容正常显示
- [ ] 页面样式正常
- [ ] **不显示**浏览量数字
- [ ] 浏览器控制台无错误（无 API 404）

### Vercel 部署验证

- [ ] Vercel 配置环境变量
- [ ] Vercel 自动构建成功
- [ ] 访问 `https://your-project.vercel.app/openeducation/`
- [ ] 文章内容正常显示
- [ ] 页面样式正常
- [ ] **显示**浏览量数字
- [ ] 刷新页面，浏览量增加
- [ ] 浏览器控制台无错误

---

## 🔍 故障排查

### 问题 1：GitHub Pages 仍显示统计组件

**原因**：环境变量未正确传递

**检查**：
```yaml
# .github/workflows/deploy.yml
env:
  PUBLIC_ENABLE_SUPABASE: 'false'  # 确保是字符串 'false'
```

**解决**：确保值用引号包裹

---

### 问题 2：Vercel 不显示统计

**原因**：环境变量未配置

**检查**：Vercel Dashboard → Settings → Environment Variables

**解决**：添加以下变量：
```
PUBLIC_ENABLE_SUPABASE=true
PUBLIC_SUPABASE_URL=...
PUBLIC_SUPABASE_ANON_KEY=...
```

---

### 问题 3：本地开发无统计

**原因**：`.env` 文件配置错误

**检查**：
```bash
# .env 文件内容
PUBLIC_ENABLE_SUPABASE=true  # 确保是 true
```

**解决**：
1. 确保 `.env` 文件在项目根目录
2. 重启开发服务器

---

### 问题 4：GitHub Pages 出现 API 404 错误

**原因**：统计脚本仍在执行

**检查**：浏览器控制台是否有 `/api/stats` 404 错误

**解决**：
1. 确认 `PUBLIC_ENABLE_SUPABASE: 'false'`
2. 清除浏览器缓存
3. 重新部署

---

## 📊 构建流程对比

### GitHub Pages 构建流程

```
推送代码到 GitHub
    ↓
触发 GitHub Actions
    ↓
设置环境变量：PUBLIC_ENABLE_SUPABASE='false'
    ↓
运行：npm run build:github
    ↓
使用：astro.config.static.ts（static 模式）
    ↓
生成：dist/ 目录（纯静态 HTML）
    ↓
部署到 GitHub Pages
    ↓
结果：无 Supabase 功能的静态网站
```

---

### Vercel 构建流程

```
推送代码到 GitHub
    ↓
Vercel 自动检测
    ↓
读取环境变量：PUBLIC_ENABLE_SUPABASE=true
    ↓
运行：npm run build:vercel
    ↓
使用：astro.config.ts（server 模式 + Vercel adapter）
    ↓
生成：.vercel/output/（SSR 输出）
    ↓
部署到 Vercel
    ↓
结果：完整功能的动态网站
```

---

## 💡 最佳实践

### 1. 环境变量命名

- ✅ 使用 `PUBLIC_` 前缀（Astro 要求）
- ✅ 使用描述性名称
- ✅ 使用字符串 `'true'`/`'false'`（避免布尔值问题）

### 2. 功能降级

- ✅ 禁用功能时不显示任何 UI（避免混淆）
- ✅ 不调用不存在的 API（避免 404 错误）
- ✅ 提供优雅的降级体验

### 3. 日志记录

```typescript
// 在脚本中添加日志
if (!enableSupabase) {
  console.log('[Info] 静态模式，Supabase 功能已禁用');
}
```

### 4. 文档维护

- ✅ 更新 README
- ✅ 记录环境变量
- ✅ 提供示例配置

---

## 🎯 总结

### 核心机制

```
环境变量：PUBLIC_ENABLE_SUPABASE
    ├─ 'true'  → 启用 Supabase（Vercel）
    └─ 'false' → 禁用 Supabase（GitHub Pages）

实现方式：
    ├─ 组件级别：条件渲染
    ├─ 脚本级别：条件执行
    └─ 页面级别：条件注入
```

### 优势

- ✅ 同一份代码，多环境部署
- ✅ 自动根据环境切换功能
- ✅ 无需手动修改代码
- ✅ 易于维护和扩展

### 访问方式

**GitHub Pages**（纯静态）：
```
https://xujinhuana.github.io/openeducation/
```

**Vercel**（完整功能）：
```
https://your-project.vercel.app/openeducation/
```

---

## 📚 相关文档

- `.env.example` - 环境变量示例
- `astro.config.ts` - Vercel 配置
- `astro.config.static.ts` - GitHub Pages 配置
- `SSR详解.md` - SSR 概念说明
- `部署终极方案.md` - 部署方案对比

---

**现在你可以同时使用两个部署平台了！** 🎉

- GitHub Pages：内容展示（免费、稳定）
- Vercel：完整体验（免费、功能齐全）

用户可以根据需要选择访问哪个版本！

